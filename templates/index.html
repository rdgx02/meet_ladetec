<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Agendamento de Salas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cleave.js/1.6.0/cleave.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cleave.js/1.6.0/addons/cleave-phone.br.js"></script>
    <style>
        .room-option {
            transition: all 0.3s ease;
        }
        .room-option:hover {
            transform: translateY(-2px);
        }
        .room-option.selected {
            background-color: #3b82f6;
            color: white;
        }
        .time-slot {
            transition: all 0.2s ease;
        }
        .time-slot:hover {
            background-color: #e5e7eb;
        }
        .time-slot.selected {
            background-color: #3b82f6;
            color: white;
        }
        .time-slot.unavailable {
            background-color: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }
        .duration-option {
            transition: all 0.2s ease;
        }
        .duration-option:hover {
            background-color: #e5e7eb;
        }
        .duration-option.selected {
            background-color: #3b82f6;
            color: white;
        }
        .repeat-option {
            transition: all 0.2s ease;
        }
        .repeat-option:hover {
            background-color: #e5e7eb;
        }
        .repeat-option.selected {
            background-color: #3b82f6;
            color: white;
        }
        .duration-option.unavailable {
    background-color: #f3f4f6 !important;
    color: #9ca3af !important;
    border-color: #d1d5db !important;
}

    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="bg-blue-600 py-4 px-6">
                <h1 class="text-2xl font-bold text-white">Agendamento de Salas de Reunião</h1>
                <p class="text-blue-100">Preencha o formulário para reservar sua sala</p>
            </div>
            
            <form id="bookingForm" class="p-6 space-y-6">
                <!-- Nome -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nome completo</label>
                    <input type="text" id="name" name="name" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Digite seu nome completo">
                </div>
                
                <!-- Setor -->
                <div>
                    <label for="sector" class="block text-sm font-medium text-gray-700 mb-1">Setor</label>
                    <select id="sector" name="sector" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="TI">TI</option>
                        <option value="RH">RH</option>
                        <option value="Financeiro">Financeiro</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                
                <!-- Telefone -->
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                    <input type="tel" id="phone" name="phone" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            placeholder="+55 21 99999-9999">
                </div>
                
                <!-- Data -->
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Data da reunião</label>
                    <input type="text" id="date" name="date" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Selecione a data">
                </div>
                
                <!-- Sala -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Selecione a sala</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="room-option cursor-pointer p-4 border border-gray-300 rounded-md text-center" data-room="203">
                            <i class="fas fa-door-open text-2xl mb-2"></i>
                            <h3 class="font-medium">Sala 203</h3>
                            <p class="text-sm text-gray-500">Capacidade: 8 pessoas</p>
                        </div>
                        <div class="room-option cursor-pointer p-4 border border-gray-300 rounded-md text-center" data-room="219">
                            <i class="fas fa-door-open text-2xl mb-2"></i>
                            <h3 class="font-medium">Sala 219</h3>
                            <p class="text-sm text-gray-500">Capacidade: 12 pessoas</p>
                        </div>
                        <div class="room-option cursor-pointer p-4 border border-gray-300 rounded-md text-center" data-room="305">
                            <i class="fas fa-door-open text-2xl mb-2"></i>
                            <h3 class="font-medium">Sala 305</h3>
                            <p class="text-sm text-gray-500">Capacidade: 6 pessoas</p>
                        </div>
                    </div>
                    <input type="hidden" id="room" name="room" required>
                </div>
                
                <!-- Horário de início -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Horário de início</label>
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2" id="timeSlotsContainer">
                        <!-- Horários serão gerados dinamicamente -->
                    </div>
                    <input type="hidden" id="startTime" name="startTime" required>
                </div>
                
                <!-- Duração -->
<div>
    <label class="block text-sm font-medium text-gray-700 mb-2">Duração</label>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
        <div class="duration-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-duration="60">
            <span class="font-medium">1 hora</span>
        </div>
        <div class="duration-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-duration="120">
            <span class="font-medium">2 horas</span>
        </div>
        <div class="duration-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-duration="180">
            <span class="font-medium">3 horas</span>
        </div>
        <div class="duration-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-duration="240">
            <span class="font-medium">4 horas</span>
        </div>
    </div>
    <input type="hidden" id="duration" name="duration" required>
</div>

                
                <!-- Repetir -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Repetir reserva</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <div class="repeat-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-repeat="none">
                            <span class="font-medium">Não repetir</span>
                        </div>
                        <div class="repeat-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-repeat="weekly">
                            <span class="font-medium">Semanalmente</span>
                        </div>
                        <div class="repeat-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-repeat="monthly">
                            <span class="font-medium">Mensalmente</span>
                        </div>
                    </div>
                    <input type="hidden" id="repeat" name="repeat" value="none">
                    
                    <div id="repeatTimesContainer" class="mt-3 hidden">
                        <label for="repeatTimes" class="block text-sm font-medium text-gray-700 mb-1">Quantas vezes repetir?</label>
                        <select id="repeatTimes" class="w-full border rounded px-3 py-2">
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                    </div>
                </div>
                
                <!-- Botão de envio -->
                <div class="pt-4">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-md transition duration-300">
                        <i class="fas fa-calendar-check mr-2"></i> Agendar Sala
                    </button>
                </div>

                <!-- Botão de consulta -->
                <div class="pt-2">
                    <button type="button" id="consultButton" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-md transition duration-300">
                        <i class="fas fa-search mr-2"></i> Consultar Agendamentos
                    </button>
                </div>

                <!-- Botão de Admin -->
                <div class="pt-2">
                    <button type="button" id="adminButton" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-4 rounded-md transition duration-300">
                        <i class="fas fa-user-shield mr-2"></i> Painel Admin
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação de Cancelamento -->
    <div id="cancellationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <div class="text-center mb-4">
                <i class="fas fa-check-circle text-green-500 text-5xl mb-3"></i>
                <h3 class="text-xl font-bold">Cancelamento realizado com sucesso!</h3>
            </div>
            
            <div class="space-y-3 mb-6">
                <div class="flex justify-between border-b pb-2">
                    <span class="font-medium">Ticket:</span>
                    <span id="cancelledTicket" class="font-bold"></span>
                </div>
                <p class="text-gray-600">Seu agendamento foi cancelado com sucesso.</p>
            </div>
            
            <div class="flex space-x-3">
                <button id="backToBookingAfterCancel" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">
                    <i class="fas fa-arrow-left mr-2"></i> Novo Agendamento
                </button>
                <button id="goToConsultAfterCancel" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded">
                    <i class="fas fa-search mr-2"></i> Consultar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <div class="text-center mb-4">
                <i class="fas fa-check-circle text-green-500 text-5xl mb-3"></i>
                <h3 class="text-xl font-bold">Agendamento realizado com sucesso!</h3>
            </div>
            
            <div class="space-y-3 mb-6">
                <div class="flex justify-between border-b pb-2">
                    <span class="font-medium">Nome:</span>
                    <span id="confirmationName"></span>
                </div>
                <div class="flex justify-between border-b pb-2">
    <span class="font-medium">Sala:</span>
    <span id="confirmationRoom"></span>
</div>
<div class="flex justify-between border-b pb-2">
    <span class="font-medium">Repetição:</span>
    <span id="confirmationRepeat"></span>
</div>


                <div class="flex justify-between border-b pb-2">
                    <span class="font-medium">Data:</span>
                    <span id="confirmationDate"></span>
                </div>
                <div class="flex justify-between border-b pb-2">
                    <span class="font-medium">Horário:</span>
                    <span id="confirmationTime"></span>
                </div>
                <div class="flex justify-between border-b pb-2">
                    <span class="font-medium">Duração:</span>
                    <span id="confirmationDuration"></span>
                </div>
                <div class="flex justify-between border-b pb-2">
                    <span class="font-medium">Ticket:</span>
                    <span id="confirmationTicket" class="font-bold"></span>
                </div>
            </div>
            
            <div class="flex space-x-3">
                <button id="backToBooking" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">
                    <i class="fas fa-arrow-left mr-2"></i> Novo Agendamento
                </button>
                <button id="goToConsult" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded">
                    <i class="fas fa-search mr-2"></i> Consultar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Login Admin -->
    <div id="adminLoginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4 text-center">Acesso Administrativo</h3>
            <div class="space-y-4">
                <div>
                    <label for="adminUsername" class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
                    <input type="text" id="adminUsername" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="adminPassword" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex space-x-3 pt-2">
                    <button id="adminLoginBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded">
                        Entrar
                    </button>
                    <button id="cancelAdminLogin" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tela de Admin -->
    <div id="adminScreen" class="fixed inset-0 bg-white p-6 hidden overflow-y-auto">
        <div class="container mx-auto px-4 max-w-6xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Painel de Administração</h2>
                <button id="closeAdmin" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por data</label>
                        <input type="text" id="adminDate" class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="Selecione a data">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pesquisar</label>
                        <input type="text" id="adminSearch" class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="Nome, Sala, Ticket...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Setor</label>
                        <select id="adminSector" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                            <option value="">Todos</option>
                            <option value="TI">TI</option>
                            <option value="RH">RH</option>
                            <option value="Financeiro">Financeiro</option>
                            <option value="Marketing">Marketing</option>
                        </select>
                    </div>
                </div>
                
                <button id="searchAdmin" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded">
                    <i class="fas fa-search mr-2"></i> Filtrar
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left">ID</th>
                            <th class="px-4 py-2 text-left">Nome</th>
                            <th class="px-4 py-2 text-left">Setor</th>
                            <th class="px-4 py-2 text-left">Sala</th>
                            <th class="px-4 py-2 text-left">Data</th>
                            <th class="px-4 py-2 text-left">Início</th>
                            <th class="px-4 py-2 text-left">Fim</th>
                            <th class="px-4 py-2 text-left">Ticket</th>
                            <th class="px-4 py-2 text-left">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="adminResults" class="divide-y divide-gray-200">
                        <!-- Os resultados serão exibidos aqui -->
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tela de Consulta -->
    <div id="consultScreen" class="fixed inset-0 bg-white p-6 hidden overflow-y-auto">
        <div class="container mx-auto max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Consultar Agendamentos</h2>
                <button id="closeConsult" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por data</label>
                        <input type="text" id="consultDate" class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="Selecione a data">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pesquisar</label>
                        <input type="text" id="consultSearch" class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="Nome, Sala, Horário...">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sala</label>
                        <select id="consultRoom" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                            <option value="">Todas</option>
                            <option value="203">Sala 203</option>
                            <option value="219">Sala 219</option>
                            <option value="305">Sala 305</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Horário</label>
                        <select id="consultTime" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                            <option value="">Qualquer horário</option>
                            <option value="8:00">8:00</option>
                            <option value="9:00">9:00</option>
                            <!-- Outros horários podem ser adicionados aqui -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Setor</label>
                        <select id="consultSector" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                            <option value="">Todos</option>
                            <option value="TI">TI</option>
                            <option value="RH">RH</option>
                            <option value="Financeiro">Financeiro</option>
                            <option value="Marketing">Marketing</option>
                        </select>
                    </div>
                </div>
                
                <button id="searchBookings" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">
                    <i class="fas fa-search mr-2"></i> Pesquisar
                </button>
            </div>
            
            <div id="bookingsResults" class="space-y-4">
                <!-- Os resultados serão exibidos aqui -->
            </div>
        </div>
    </div>

    <script>
    const ADMIN_CREDENTIALS = {
        username: 'admin',
        password: 'admin123'
    };

    // Função util para calcular fim
    function calculateEndTime(startTime, duration) {
        const [hours, minutes] = startTime.split(':').map(Number);
        const totalMinutes = hours * 60 + minutes + duration;
        const endHours = Math.floor(totalMinutes / 60);
        const endMinutes = totalMinutes % 60;
        return `${endHours}:${endMinutes.toString().padStart(2, '0')}`;
    }

    // Pega todos os agendamentos do backend
    async function getAllBookings() {
        const res = await fetch('/api/bookings');
        return await res.json();
    }

    // Salva agendamento
    async function saveBooking(booking) {
        const res = await fetch('/api/bookings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(booking)
        });
        return await res.json();
    }

    // Deleta agendamento
    async function deleteBooking(id) {
        await fetch(`/api/bookings/${id}`, { method: 'DELETE' });
    }

    // Verifica se o horário está disponível
    async function isTimeSlotAvailable(room, date, startTime, duration) {
        const bookings = await getAllBookings();
        const [startHour, startMinute] = startTime.split(':').map(Number);
        const startTotal = startHour * 60 + startMinute;
        const endTotal = startTotal + duration;

        return !bookings.some(b => {
            if (b.room !== room || b.date !== date) return false;
            const [bHour, bMin] = b.start_time.split(':').map(Number);
            const bStart = bHour * 60 + bMin;
            const bEnd = bStart + b.duration;
            return !(endTotal <= bStart || startTotal >= bEnd);
        });
    }

    // INÍCIO: DOM READY
    document.addEventListener('DOMContentLoaded', function () {
        // Máscara telefone
        new Cleave('#phone', {
            phone: true,
            phoneRegionCode: 'BR'
        });

        // Flatpickr datas
        flatpickr("#date", {
            minDate: "today",
            dateFormat: "d/m/Y",
            disable: [date => date.getDay() === 0 || date.getDay() === 6],
            locale: { firstDayOfWeek: 1 },
            onChange: () => updateAvailableTimeSlots()
        });

                // Flatpickr para filtro de data na consulta
        flatpickr("#consultDate", {
            dateFormat: "d/m/Y",
            locale: { firstDayOfWeek: 1 }
        });


        // Seleção sala
        const roomOptions = document.querySelectorAll('.room-option');
        roomOptions.forEach(opt => {
            opt.addEventListener('click', function () {
                roomOptions.forEach(o => o.classList.remove('selected', 'border-blue-500'));
                this.classList.add('selected', 'border-blue-500');
                document.getElementById('room').value = this.dataset.room;
                updateAvailableTimeSlots();
            });
        });

        // Atualiza horários disponíveis
        async function updateAvailableTimeSlots() {
            const room = document.getElementById('room').value;
            const date = document.getElementById('date').value;
            const container = document.getElementById('timeSlotsContainer');
            container.innerHTML = '';
            if (!room || !date) return;

            for (let hour = 8; hour <= 21; hour++) {
                const time = `${hour}:00`;
                const available = await isTimeSlotAvailable(room, date, time, 30);
                const div = document.createElement('div');
                div.className = `time-slot cursor-pointer p-2 border rounded-md text-center ${available ? 'border-gray-300' : 'border-gray-200 unavailable'}`;
                div.textContent = time;
                div.dataset.time = time;
                if (available) {
    div.addEventListener('click', async function () {
        document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected', 'border-blue-500'));
        this.classList.add('selected', 'border-blue-500');
        document.getElementById('startTime').value = this.dataset.time;

        // Verifica quais durações cabem após o horário selecionado
        const durations = [30, 60, 90, 120];
        const room = document.getElementById('room').value;
        const date = document.getElementById('date').value;
        const startTime = this.dataset.time;

        for (let option of document.querySelectorAll('.duration-option')) {
            const duration = parseInt(option.dataset.duration);
            const fits = await isTimeSlotAvailable(room, date, startTime, duration);
            if (fits) {
                option.classList.remove('unavailable', 'opacity-50', 'cursor-not-allowed');
                option.classList.add('cursor-pointer');
                option.style.pointerEvents = 'auto';
            } else {
                option.classList.remove('selected', 'cursor-pointer');
                option.classList.add('unavailable', 'opacity-50', 'cursor-not-allowed');
                option.style.pointerEvents = 'none';
            }
        }

        // Limpa seleção anterior de duração
        document.getElementById('duration').value = '';
        document.querySelectorAll('.duration-option').forEach(opt => opt.classList.remove('selected', 'border-blue-500'));
    });
}

                container.appendChild(div);
            }
        }

        // Duração
        document.querySelectorAll('.duration-option').forEach(opt => {
            opt.addEventListener('click', function () {
                document.querySelectorAll('.duration-option').forEach(o => o.classList.remove('selected', 'border-blue-500'));
                this.classList.add('selected', 'border-blue-500');
                document.getElementById('duration').value = this.dataset.duration;
            });
        });

        // Repetição
const repeatOptions = document.querySelectorAll('.repeat-option');
const repeatTimesContainer = document.getElementById('repeatTimesContainer');

repeatOptions.forEach(opt => {
    opt.addEventListener('click', function () {
        function updateRepeatTimesLabel(type) {
            const select = document.getElementById('repeatTimes');
            const label = type === 'weekly' ? ' semanas' : ' meses';

            [...select.options].forEach(opt => {
                opt.textContent = opt.value + label;
            });
        }

        updateRepeatTimesLabel(this.dataset.repeat); // aplica rótulos ao selecionar

        repeatOptions.forEach(o => o.classList.remove('selected', 'border-blue-500'));
        this.classList.add('selected', 'border-blue-500');
        document.getElementById('repeat').value = this.dataset.repeat;
        repeatTimesContainer.classList.toggle('hidden', this.dataset.repeat === 'none');
    });
});

                repeatOptions.forEach(o => o.classList.remove('selected', 'border-blue-500'));
                this.classList.add('selected', 'border-blue-500');
                document.getElementById('repeat').value = this.dataset.repeat;
                
                repeatTimesContainer.classList.toggle('hidden', this.dataset.repeat === 'none');
            });

        // Submissão do formulário
        document.getElementById('bookingForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const fields = ['name', 'phone', 'date', 'room', 'startTime', 'duration'];
            let valid = true;
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (!el.value) {
                    el.classList.add('border-red-500');
                    valid = false;
                } else {
                    el.classList.remove('border-red-500');
                }
            });
            if (!valid) return alert('Preencha todos os campos obrigatórios.');

            const booking = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                sector: document.getElementById('sector').value,
                room: document.getElementById('room').value,
                date: document.getElementById('date').value,
                startTime: document.getElementById('startTime').value,
                duration: parseInt(document.getElementById('duration').value)
            };

            const available = await isTimeSlotAvailable(booking.room, booking.date, booking.startTime, booking.duration);
            if (!available) return alert('Este horário está indisponível.');

           const repeat = document.getElementById('repeat').value;
const repeatTimes = parseInt(document.getElementById('repeatTimes').value || 0);
const bookingsToCreate = [booking];

if (repeat === 'weekly' || repeat === 'monthly') {
    let [day, month, year] = booking.date.split('/').map(Number);
    let originalDate = new Date(year, month - 1, day);

    for (let i = 1; i < repeatTimes; i++) {
        let nextDate = new Date(originalDate);
        if (repeat === 'weekly') {
            nextDate.setDate(originalDate.getDate() + (7 * i));
        } else if (repeat === 'monthly') {
            nextDate.setMonth(originalDate.getMonth() + i);
        }

        const formatted = nextDate.toLocaleDateString('pt-BR');
        bookingsToCreate.push({ ...booking, date: formatted });
    }
}

    // Inicializa variável global para exibir todos os tickets
let allTickets = [];

for (let i = 0; i < bookingsToCreate.length; i++) {
    const b = bookingsToCreate[i];
    const available = await isTimeSlotAvailable(b.room, b.date, b.startTime, b.duration);
    if (!available) continue;

    const saved = await saveBooking(b);
    allTickets.push(saved.ticket); // Salva ticket

    if (i === 0) {
        // Mostra dados do primeiro agendamento no modal
        document.getElementById('confirmationName').textContent = saved.name;
        document.getElementById('confirmationRoom').textContent = 'Sala ' + saved.room;
        document.getElementById('confirmationDate').textContent = saved.date;

        const [hora, minuto] = saved.start_time.split(':').map(Number);
        const fim = new Date(0, 0, 0, hora, minuto + saved.duration);
        const fimStr = fim.toTimeString().slice(0, 5);
        document.getElementById('confirmationTime').textContent = `${saved.start_time} às ${fimStr}`;

        const duracaoMin = saved.duration;
        const horas = Math.floor(duracaoMin / 60);
        const minutos = duracaoMin % 60;
        let textoDuracao = '';
        if (horas > 0) textoDuracao += `${horas}h`;
        if (minutos > 0) textoDuracao += (horas > 0 ? ' ' : '') + `${minutos}min`;
        document.getElementById('confirmationDuration').textContent = textoDuracao;

        const repeat = document.getElementById('repeat').value;
        const times = parseInt(document.getElementById('repeatTimes').value || 0);
        let repeatLabel = 'Não';
        if (repeat === 'weekly') repeatLabel = `Semanal – ${times}x`;
        if (repeat === 'monthly') repeatLabel = `Mensal – ${times}x`;
        document.getElementById('confirmationRepeat').textContent = repeatLabel;

        // Exibe modal de confirmação
        document.getElementById('confirmationModal').classList.remove('hidden');
    }
}

// Mostra os tickets no campo final
document.getElementById('confirmationTicket').textContent = allTickets.join(', ');

// Reseta formulário
this.reset();

        // Modal navegação
        document.getElementById('backToBooking').addEventListener('click', () => {
            document.getElementById('confirmationModal').classList.add('hidden');
        });
});
        // Abrir tela de consulta e carregar dados
document.getElementById('consultButton').addEventListener('click', async () => {
    const consultScreen = document.getElementById('consultScreen');
    consultScreen.classList.remove('hidden');

    const bookings = await getAllBookings();
    const container = document.getElementById('bookingsResults');
    container.innerHTML = '';

    bookings.forEach(b => {
  const div = document.createElement('div');
  div.className = 'border rounded-lg shadow-md p-4 mb-4 relative bg-white border-l-4 border-blue-500';

  div.innerHTML = `
    <h2 class="text-lg font-semibold mb-2">Sala ${b.room}</h2>
    <p class="flex items-center gap-2 mb-1 text-sm">
      <i class="fa fa-user text-gray-500"></i> ${b.name}
    </p>
    <p class="flex items-center gap-2 mb-1 text-sm">
      <i class="fa fa-calendar text-gray-500"></i> ${b.date}
    </p>
    <p class="flex items-center gap-2 mb-1 text-sm">
      <i class="fa fa-clock text-gray-500"></i> ${b.start_time} - ${calculateEndTime(b.start_time, b.duration)}
    </p>
    <span class="inline-block bg-gray-100 text-xs font-mono px-2 py-1 rounded mt-2">${b.ticket}</span>
    <span class="absolute top-4 right-4 text-xs px-2 py-1 rounded bg-gray-100">${b.sector}</span>
    <button class="text-red-600 flex items-center gap-1 mt-3 text-sm cancel-btn" data-id="${b.id}" data-ticket="${b.ticket}">
      <i class="fa fa-trash"></i> Cancelar
    </button>
  `;
    container.appendChild(div);

    // Ativar o botão cancelar com verificação do ticket
    const cancelBtn = div.querySelector('.cancel-btn');
    cancelBtn.addEventListener('click', () => {
        const ticket = cancelBtn.dataset.ticket;
        const id = cancelBtn.dataset.id;
        const modal = document.getElementById('confirmCancelModal');
        const input = document.getElementById('cancelTicketInput');
        const confirmBtn = document.getElementById('confirmTicketBtn');
        const cancelBtnModal = document.getElementById('cancelTicketBtn');

        modal.classList.remove('hidden');
        input.value = '';

        confirmBtn.onclick = async () => {
            if (input.value.trim() === ticket) {
                await deleteBooking(id);
                modal.classList.add('hidden');
                alert('Agendamento cancelado com sucesso!');
                document.getElementById('consultButton').click();
            } else {
                alert('Ticket incorreto!');
            }
        };

        cancelBtnModal.onclick = () => {
            modal.classList.add('hidden');
        };
    });
});
});


// Fechar tela de consulta
document.getElementById('closeConsult').addEventListener('click', () => {
    document.getElementById('consultScreen').classList.add('hidden');
});
    // Filtro da tela de consulta
document.getElementById('searchBookings').addEventListener('click', async () => {
    const filterDate = document.getElementById('consultDate').value;
    const filterSearch = document.getElementById('consultSearch').value.toLowerCase();
    const filterRoom = document.getElementById('consultRoom').value;
    const filterTime = document.getElementById('consultTime').value;
    const filterSector = document.getElementById('consultSector').value;

    const bookings = await getAllBookings();
    const container = document.getElementById('bookingsResults');
    container.innerHTML = '';

    bookings
        .filter(b => {
            const matchDate = !filterDate || b.date === filterDate;
            const matchRoom = !filterRoom || b.room === filterRoom;
            const matchTime = !filterTime || b.start_time === filterTime;
            const matchSector = !filterSector || b.sector === filterSector;
            const matchSearch = !filterSearch || (
                b.name.toLowerCase().includes(filterSearch) ||
                b.room.toLowerCase().includes(filterSearch) ||
                b.start_time.toLowerCase().includes(filterSearch) ||
                b.ticket.toLowerCase().includes(filterSearch)
            );
            return matchDate && matchRoom && matchTime && matchSector && matchSearch;
        })
        .forEach(b => {
    const div = document.createElement('div');
    div.className = 'border p-4 rounded shadow-sm bg-white';
    div.innerHTML = `
        <p><strong>Nome:</strong> ${b.name}</p>
        <p><strong>Sala:</strong> ${b.room}</p>
        <p><strong>Data:</strong> ${b.date}</p>
        <p><strong>Início:</strong> ${b.start_time}</p>
        <p><strong>Duração:</strong> ${b.duration} min</p>
        <p><strong>Setor:</strong> ${b.sector}</p>
        <p><strong>Ticket:</strong> <span class="ticket-code">${b.ticket}</span></p>
        <button class="cancel-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 mt-2 rounded" data-id="${b.id}" data-ticket="${b.ticket}">
            <i class="fas fa-times mr-1"></i> Cancelar
        </button>
    `;
    container.appendChild(div);

    // Ativar botão cancelar com ticket
    const cancelBtn = div.querySelector('.cancel-btn');
    cancelBtn.addEventListener('click', () => {
        const ticket = cancelBtn.dataset.ticket;
        const id = cancelBtn.dataset.id;
        const modal = document.getElementById('confirmCancelModal');
        const input = document.getElementById('cancelTicketInput');
        const confirmBtn = document.getElementById('confirmTicketBtn');
        const cancelBtnModal = document.getElementById('cancelTicketBtn');

        modal.classList.remove('hidden');
        input.value = '';

        confirmBtn.onclick = async () => {
            if (input.value.trim() === ticket) {
                await deleteBooking(id);
                modal.classList.add('hidden');
                alert('Agendamento cancelado com sucesso!');
                document.getElementById('consultButton').click(); // Recarrega
            } else {
                alert('Ticket incorreto!');
            }
        };

        cancelBtnModal.onclick = () => {
            modal.classList.add('hidden');
        };
    });
});

});


// Abrir modal de login admin
document.getElementById('adminButton').addEventListener('click', () => {
    document.getElementById('adminLoginModal').classList.remove('hidden');
});

// Cancelar login admin
document.getElementById('cancelAdminLogin').addEventListener('click', () => {
    document.getElementById('adminLoginModal').classList.add('hidden');
});

// Login admin
document.getElementById('adminLoginBtn').addEventListener('click', async () => {
    const user = document.getElementById('adminUsername').value;
    const pass = document.getElementById('adminPassword').value;

    if (user === ADMIN_CREDENTIALS.username && pass === ADMIN_CREDENTIALS.password) {
        document.getElementById('adminLoginModal').classList.add('hidden');
        document.getElementById('adminScreen').classList.remove('hidden');

        const bookings = await getAllBookings();
        const tbody = document.getElementById('adminResults');
        tbody.innerHTML = '';

        bookings.forEach(b => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-4 py-2">${b.id}</td>
                <td class="px-4 py-2">${b.name}</td>
                <td class="px-4 py-2">${b.sector}</td>
                <td class="px-4 py-2">${b.room}</td>
                <td class="px-4 py-2">${b.date}</td>
                <td class="px-4 py-2">${b.start_time}</td>
                <td class="px-4 py-2">${calculateEndTime(b.start_time, b.duration)}</td>
                <td class="px-4 py-2">${b.ticket}</td>
                <td class="px-4 py-2">
                    <button class="text-red-500 hover:underline delete-btn" data-id="${b.id}">Cancelar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (confirm('Tem certeza que deseja cancelar este agendamento?')) {
                    await deleteBooking(btn.dataset.id);
                    btn.closest('tr').remove();
                }
            });
        });
    } else {
        alert('Usuário ou senha incorretos');
    }
});


// Fechar painel admin
document.getElementById('closeAdmin').addEventListener('click', () => {
    document.getElementById('adminScreen').classList.add('hidden');
});
    // Botão "Consultar" no modal de sucesso
document.getElementById('goToConsult').addEventListener('click', async () => {
    document.getElementById('confirmationModal').classList.add('hidden');
    document.getElementById('consultButton').click();
});

        // TODO: completar lógica de consulta e admin (depois)

</script>
<!-- Modal de Confirmação de Cancelamento com Ticket -->
<div id="confirmCancelModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white p-6 rounded-lg max-w-sm w-full">
    <h3 class="text-lg font-bold mb-4">Confirmação de Cancelamento</h3>
    <p class="text-gray-700 mb-2">Digite o <strong>ticket</strong> para confirmar o cancelamento:</p>
    <input type="text" id="cancelTicketInput" class="w-full px-4 py-2 border rounded-md mb-4" placeholder="Ex: TKT-XXXXX">
    <div class="flex justify-end space-x-3">
      <button id="cancelTicketBtn" class="bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
      <button id="confirmTicketBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Confirmar</button>
    </div>
  </div>
</div>

</body>
</html>
