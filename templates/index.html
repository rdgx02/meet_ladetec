<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Agendamento de Salas</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cleave.js/1.6.0/cleave.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cleave.js/1.6.0/addons/cleave-phone.br.js"></script>

  <style>
    .room-option{transition:.3s} .room-option:hover{transform:translateY(-2px)}
    .room-option.selected{background:#3b82f6;color:#fff}
    .time-slot{transition:.2s} .time-slot:hover{background:#e5e7eb}
    .time-slot.selected{background:#3b82f6;color:#fff}
    .time-slot.unavailable{background:#f3f4f6;color:#9ca3af;cursor:not-allowed}
    .duration-option{transition:.2s} .duration-option:hover{background:#e5e7eb}
    .duration-option.selected{background:#3b82f6;color:#fff}
    .repeat-option{transition:.2s} .repeat-option:hover{background:#e5e7eb}
    .repeat-option.selected{background:#3b82f6;color:#fff}
    .duration-option.unavailable{background:#f3f4f6!important;color:#9ca3af!important;border-color:#d1d5db!important}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
      <div class="bg-blue-600 py-4 px-6">
        <h1 class="text-2xl font-bold text-white">Agendamento de Salas de Reunião</h1>
        <p class="text-blue-100">Preencha o formulário para reservar sua sala</p>
      </div>

      <form id="bookingForm" class="p-6 space-y-6">
        <!-- Nome -->
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nome completo</label>
          <input type="text" id="name" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Digite seu nome completo">
        </div>

        <!-- Setor -->
        <div>
          <label for="sector" class="block text-sm font-medium text-gray-700 mb-1">Setor</label>
          <select id="sector" name="sector" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            <option value="TI">TI</option>
            <option value="RH">RH</option>
            <option value="Financeiro">Financeiro</option>
            <option value="Marketing">Marketing</option>
            <option value="Outro">Outro</option>
          </select>
        </div>

        <!-- Telefone -->
        <div>
          <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
          <input type="tel" id="phone" name="phone" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="+55 21 99999-9999">
        </div>

        <!-- Data -->
        <div>
          <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Data da reunião</label>
          <input type="text" id="date" name="date" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Selecione a data">
        </div>

        <!-- Sala -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Selecione a sala</label>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="room-option cursor-pointer p-4 border border-gray-300 rounded-md text-center" data-room="203">
              <i class="fas fa-door-open text-2xl mb-2"></i><h3 class="font-medium">Sala 203</h3>
            </div>
            <div class="room-option cursor-pointer p-4 border border-gray-300 rounded-md text-center" data-room="219">
              <i class="fas fa-door-open text-2xl mb-2"></i><h3 class="font-medium">Sala 219</h3>
            </div>
            <div class="room-option cursor-pointer p-4 border border-gray-300 rounded-md text-center" data-room="305">
              <i class="fas fa-door-open text-2xl mb-2"></i><h3 class="font-medium">Sala 305</h3>
            </div>
          </div>
          <input type="hidden" id="room" name="room" required>
        </div>

        <!-- Horário de início -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Horário de início</label>
          <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2" id="timeSlotsContainer"></div>
          <input type="hidden" id="startTime" name="startTime" required>
        </div>

        <!-- Duração -->
<div>
  <label class="block text-sm font-medium text-gray-700 mb-2">Duração</label>
  <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
    <div class="duration-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-duration="60"><span class="font-medium">1 hora</span></div>
    <div class="duration-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-duration="120"><span class="font-medium">2 horas</span></div>
    <div class="duration-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-duration="180"><span class="font-medium">3 horas</span></div>
    <div class="duration-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-duration="240"><span class="font-medium">4 horas</span></div>
    <div class="duration-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-duration="300"><span class="font-medium">5 horas</span></div>
    <div class="duration-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-duration="360"><span class="font-medium">6 horas</span></div>
    <div class="duration-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-duration="420"><span class="font-medium">7 horas</span></div>
    <div class="duration-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-duration="480"><span class="font-medium">8 horas</span></div>
    <div class="duration-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-duration="540"><span class="font-medium">9 horas</span></div>
    <div class="duration-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-duration="600"><span class="font-medium">10 horas</span></div>
  </div>
  <input type="hidden" id="duration" name="duration" required>
</div>


        <!-- Repetir -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Repetir reserva</label>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
            <div class="repeat-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-repeat="none"><span class="font-medium">Não repetir</span></div>
            <div class="repeat-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-repeat="weekly"><span class="font-medium">Semanalmente</span></div>
            <div class="repeat-option cursor-pointer p-3 border border-gray-300 rounded-md text-center" data-repeat="monthly"><span class="font-medium">Mensalmente</span></div>
          </div>
          <input type="hidden" id="repeat" name="repeat" value="none">
          <div id="repeatTimesContainer" class="mt-3 hidden">
            <label for="repeatTimes" class="block text-sm font-medium text-gray-700 mb-1">Quantas vezes repetir?</label>
            <select id="repeatTimes" class="w-full border rounded px-3 py-2">
              <option value="2">2</option><option value="3">3</option><option value="4">4</option>
              <option value="5">5</option><option value="6">6</option><option value="7">7</option>
              <option value="8">8</option><option value="9">9</option><option value="10">10</option>
              <option value="11">11</option><option value="12">12</option>
            </select>
          </div>
        </div>

        <!-- Envio -->
        <div class="pt-4">
          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-md transition duration-300">
            <i class="fas fa-calendar-check mr-2"></i> Agendar Sala
          </button>
        </div>

        <!-- Consulta -->
        <div class="pt-2">
          <button type="button" id="consultButton" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-md transition duration-300">
            <i class="fas fa-search mr-2"></i> Consultar Agendamentos
          </button>
        </div>
        </form>
       <!-- Link simples para Admin -->
            <div class="pt-2">
           <a href="/admin" target="_blank" rel="noopener"
  class="block text-center bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-4 w-full">
  <i class="fas fa-user-shield mr-2"></i> Painel Admin
</a>


            </div>
    </div>
  </div>

  <!-- Modal Confirmação (público) -->
  <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <div class="text-center mb-4">
        <i class="fas fa-check-circle text-green-500 text-5xl mb-3"></i>
        <h3 class="text-xl font-bold">Agendamento realizado com sucesso!</h3>
      </div>
      <div class="space-y-3 mb-6">
        <div class="flex justify-between border-b pb-2"><span class="font-medium">Nome:</span><span id="confirmationName"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="font-medium">Sala:</span><span id="confirmationRoom"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="font-medium">Repetição:</span><span id="confirmationRepeat"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="font-medium">Data:</span><span id="confirmationDate"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="font-medium">Horário:</span><span id="confirmationTime"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="font-medium">Duração:</span><span id="confirmationDuration"></span></div>
        <div class="flex justify-between border-b pb-2"><span class="font-medium">Ticket:</span><span id="confirmationTicket" class="font-bold"></span></div>
      </div>
      <div class="flex space-x-3">
        <button id="backToBooking" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">
          <i class="fas fa-arrow-left mr-2"></i> Novo Agendamento
        </button>
        <button id="goToConsult" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded">
          <i class="fas fa-search mr-2"></i> Consultar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Confirmação de Cancelamento (ticket) -->
  <div id="confirmCancelModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-sm w-full">
      <h3 class="text-lg font-bold mb-4">Confirmação de Cancelamento</h3>
      <p class="text-gray-700 mb-2">Digite o <strong>ticket</strong> para confirmar o cancelamento:</p>
      <input type="text" id="cancelTicketInput" class="w-full px-4 py-2 border rounded-md mb-4" placeholder="Ex: TKT-XXXXX">
      <div class="flex justify-end space-x-3">
        <button id="cancelTicketBtn" class="bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
        <button id="confirmTicketBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Tela de Consulta (pública) -->
  <div id="consultScreen" class="fixed inset-0 bg-white p-6 hidden overflow-y-auto">
    <div class="container mx-auto max-w-4xl">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Consultar Agendamentos</h2>
        <button id="closeConsult" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-2xl"></i></button>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por data</label>
            <input type="text" id="consultDate" class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="Selecione a data">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Pesquisar</label>
            <input type="text" id="consultSearch" class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="Nome, Sala, Horário...">
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Sala</label>
            <select id="consultRoom" class="w-full px-4 py-2 border border-gray-300 rounded-md">
              <option value="">Todas</option>
              <option value="203">Sala 203</option>
              <option value="219">Sala 219</option>
              <option value="305">Sala 305</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Horário</label>
            <select id="consultTime" class="w-full px-4 py-2 border border-gray-300 rounded-md">
              <option value="">Qualquer horário</option>
              <option value="8:00">8:00</option>
              <option value="9:00">9:00</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Setor</label>
            <select id="consultSector" class="w-full px-4 py-2 border border-gray-300 rounded-md">
              <option value="">Todos</option>
              <option value="TI">TI</option>
              <option value="RH">RH</option>
              <option value="Financeiro">Financeiro</option>
              <option value="Marketing">Marketing</option>
            </select>
          </div>
        </div>

        <button id="searchBookings" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">
          <i class="fas fa-search mr-2"></i> Pesquisar
        </button>
        <button id="clearConsultFilters" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded mt-2">
          <i class="fas fa-eraser mr-2"></i> Limpar Filtros
        </button>
      </div>

      <div id="bookingsResults" class="space-y-4"></div>
    </div>
  </div>

  <!-- Card final de cancelamento na consulta -->
  <div id="consultCancelSuccess" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-lg max-w-md w-full text-center shadow-lg">
      <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
      <h3 class="text-xl font-bold mb-2">Agendamento cancelado com sucesso!</h3>
      <p id="consultCancelInfo" class="text-gray-700 mb-4"></p>
      <div class="flex justify-center">
        <button id="cancelBackToConsult" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
          <i class="fas fa-search mr-1"></i> Consultar Novamente
        </button>
      </div>
    </div>
  </div>

  <script>
    // ===== util =====
    function calculateEndTime(startTime, duration){
      const [h,m]=startTime.split(':').map(Number);
      const end=h*60+m+duration;
      const eh=Math.floor(end/60), em=end%60;
      return `${eh}:${String(em).padStart(2,'0')}`;
    }
    async function getAllBookings(){ const r=await fetch('/api/bookings'); return r.json(); }
    async function saveBooking(booking){
      const r=await fetch('/api/bookings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(booking)});
      return r.json();
    }
    async function deleteBooking(id){ await fetch(`/api/bookings/${id}`,{method:'DELETE'}); }
    async function isTimeSlotAvailable(room,date,startTime,duration){
      const bookings=await getAllBookings();
      const [sh,sm]=startTime.split(':').map(Number);
      const s=sh*60+sm, e=s+duration;
      return !bookings.some(b=>{
        if(b.room!==room||b.date!==date) return false;
        const [bh,bm]=b.start_time.split(':').map(Number);
        const bs=bh*60+bm, be=bs+b.duration;
        return !(e<=bs || s>=be);
      });
    }

    // ===== página pública =====
    document.addEventListener('DOMContentLoaded', function(){
      // máscara telefone
      new Cleave('#phone',{phone:true,phoneRegionCode:'BR',prefix:'+55 ',noImmediatePrefix:true,rawValueTrimPrefix:true});

      // datas
      flatpickr('#date',{minDate:'today',dateFormat:'d/m/Y',disable:[d=>d.getDay()===0||d.getDay()===6],locale:{firstDayOfWeek:1},onChange:()=>updateAvailableTimeSlots()});
      flatpickr('#consultDate',{dateFormat:'d/m/Y',locale:{firstDayOfWeek:1}});

      // seleção de sala
      const roomOptions=document.querySelectorAll('.room-option');
      roomOptions.forEach(opt=>{
        opt.addEventListener('click',function(){
          roomOptions.forEach(o=>o.classList.remove('selected','border-blue-500'));
          this.classList.add('selected','border-blue-500');
          document.getElementById('room').value=this.dataset.room;
          updateAvailableTimeSlots();
        });
      });

      // gerar horários disponíveis com intervalos de 15 minutos
async function updateAvailableTimeSlots(){
  const room = document.getElementById('room').value;
  const date = document.getElementById('date').value;
  const container = document.getElementById('timeSlotsContainer');
  container.innerHTML = '';
  if (!room || !date) return;

  const today = new Date();
  const [d, m, y] = date.split('/').map(Number);
  const selected = new Date(y, m - 1, d);
  const isToday = today.toDateString() === selected.toDateString();

  // Gera horários de 15 em 15 minutos, das 08:00 até 21:00
  for (let minutes = 8 * 60; minutes <= 21 * 60; minutes += 30) {
    const hh = Math.floor(minutes / 60);
    const mm = minutes % 60;
    const time = `${hh}:${String(mm).padStart(2, '0')}`;

    if (isToday) {
      const now = today.getHours() * 60 + today.getMinutes();
      if (minutes <= now) continue;
    }

    const free = await isTimeSlotAvailable(room, date, time, 30);
    const el = document.createElement('div');
    el.className = `time-slot cursor-pointer p-2 border rounded-md text-center ${free ? 'border-gray-300' : 'border-gray-200 unavailable'}`;
    el.textContent = time;
    el.dataset.time = time;

    if (free) {
      el.addEventListener('click', async function () {
        document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected', 'border-blue-500'));
        this.classList.add('selected', 'border-blue-500');
        document.getElementById('startTime').value = this.dataset.time;

        for (const op of document.querySelectorAll('.duration-option')) {
          const dur = parseInt(op.dataset.duration);
          const fits = await isTimeSlotAvailable(room, date, this.dataset.time, dur);
          if (fits) {
            op.classList.remove('unavailable', 'opacity-50', 'cursor-not-allowed');
            op.classList.add('cursor-pointer');
            op.style.pointerEvents = 'auto';
          } else {
            op.classList.remove('selected', 'cursor-pointer');
            op.classList.add('unavailable', 'opacity-50', 'cursor-not-allowed');
            op.style.pointerEvents = 'none';
          }
        }

        document.getElementById('duration').value = '';
        document.querySelectorAll('.duration-option').forEach(o => o.classList.remove('selected', 'border-blue-500'));
      });
    }

    container.appendChild(el);
  }
}


      // duração
      document.querySelectorAll('.duration-option').forEach(opt=>{
        opt.addEventListener('click',function(){
          document.querySelectorAll('.duration-option').forEach(o=>o.classList.remove('selected','border-blue-500'));
          this.classList.add('selected','border-blue-500');
          document.getElementById('duration').value=this.dataset.duration;
        });
      });

      // repetição
      const repeatOptions=document.querySelectorAll('.repeat-option');
      const repeatTimesContainer=document.getElementById('repeatTimesContainer');
      repeatOptions.forEach(opt=>{
        opt.addEventListener('click',function(){
          const select=document.getElementById('repeatTimes');
          const label=this.dataset.repeat==='weekly'?' semanas':' meses';
          [...select.options].forEach(o=>o.textContent=o.value+label);
          repeatOptions.forEach(o=>o.classList.remove('selected','border-blue-500'));
          this.classList.add('selected','border-blue-500');
          document.getElementById('repeat').value=this.dataset.repeat;
          repeatTimesContainer.classList.toggle('hidden',this.dataset.repeat==='none');
        });
      });

      // submit
      document.getElementById('bookingForm').addEventListener('submit', async function(e){
        e.preventDefault();
        const fields=['name','phone','date','room','startTime','duration'];
        let ok=true;
        fields.forEach(id=>{
          const el=document.getElementById(id);
          if(!el.value){ el.classList.add('border-red-500'); ok=false; }
          else el.classList.remove('border-red-500');
        });
        if(!ok) return alert('Preencha todos os campos obrigatórios.');

        const booking={
          name:document.getElementById('name').value,
          phone:document.getElementById('phone').value,
          sector:document.getElementById('sector').value,
          room:document.getElementById('room').value,
          date:document.getElementById('date').value,
          startTime:document.getElementById('startTime').value,
          duration:parseInt(document.getElementById('duration').value)
        };

        const free=await isTimeSlotAvailable(booking.room,booking.date,booking.startTime,booking.duration);
        if(!free) return alert('Este horário está indisponível.');

        const repeat=document.getElementById('repeat').value;
        const repeatTimes=parseInt(document.getElementById('repeatTimes').value||0);
        const toCreate=[booking];

        if(repeat==='weekly'||repeat==='monthly'){
          const [day,month,year]=booking.date.split('/').map(Number);
          const base=new Date(year,month-1,day);
          for(let i=1;i<repeatTimes;i++){
            const next=new Date(base);
            if(repeat==='weekly') next.setDate(base.getDate()+7*i);
            else next.setMonth(base.getMonth()+i);
            toCreate.push({...booking,date:next.toLocaleDateString('pt-BR')});
          }
        }

        let tickets=[];
        for(let i=0;i<toCreate.length;i++){
          const b=toCreate[i];
          if(!(await isTimeSlotAvailable(b.room,b.date,b.startTime,b.duration))) continue;
          const saved=await saveBooking(b);
          tickets.push(saved.ticket);

          if(i===0){
            document.getElementById('confirmationName').textContent=saved.name;
            document.getElementById('confirmationRoom').textContent='Sala '+saved.room;
            document.getElementById('confirmationDate').textContent=saved.date;

            const [hh,mm]=saved.start_time.split(':').map(Number);
            const end=new Date(0,0,0,hh,mm+saved.duration).toTimeString().slice(0,5);
            document.getElementById('confirmationTime').textContent=`${saved.start_time} às ${end}`;

            const d=saved.duration, h=Math.floor(d/60), m=d%60;
            document.getElementById('confirmationDuration').textContent=`${h?h+'h':''}${m?(h?' ':'')+m+'min':''}`;

            let rep='Não'; const times=parseInt(document.getElementById('repeatTimes').value||0);
            if(repeat==='weekly') rep=`Semanal – ${times}x`;
            if(repeat==='monthly') rep=`Mensal – ${times}x`;
            document.getElementById('confirmationRepeat').textContent=rep;

            document.getElementById('confirmationModal').classList.remove('hidden');
          }
        }
        document.getElementById('confirmationTicket').textContent=tickets.join(', ');
        this.reset();

        document.getElementById('backToBooking').addEventListener('click',()=>document.getElementById('confirmationModal').classList.add('hidden'));
      });

      // abrir consulta
      document.getElementById('consultButton').addEventListener('click', async ()=>{
        const consultScreen=document.getElementById('consultScreen');
        consultScreen.classList.remove('hidden');

        const bookings=await getAllBookings();
        const container=document.getElementById('bookingsResults');
        container.innerHTML='';

        bookings.forEach(b=>{
          const div=document.createElement('div');
          div.className='border rounded-lg shadow-md p-4 mb-4 relative bg-white border-l-4 border-blue-500';
          div.innerHTML=`
            <h2 class="text-lg font-semibold mb-2">Sala ${b.room}</h2>
            <p class="flex items-center gap-2 mb-1 text-sm"><i class="fa fa-user text-gray-500"></i> ${b.name}</p>
            <p class="flex items-center gap-2 mb-1 text-sm"><i class="fa fa-calendar text-gray-500"></i> ${b.date}</p>
            <p class="flex items-center gap-2 mb-1 text-sm"><i class="fa fa-clock text-gray-500"></i> ${b.start_time} - ${calculateEndTime(b.start_time,b.duration)}</p>
            <span class="absolute top-4 right-4 text-xs px-2 py-1 rounded bg-gray-100">${b.sector}</span>
            <button class="cancel-btn flex items-center gap-1 bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm shadow mt-3" data-id="${b.id}" data-ticket="${b.ticket}">
              <i class="fas fa-trash-alt"></i> Cancelar
            </button>`;
          container.appendChild(div);

          const cancelBtn=div.querySelector('.cancel-btn');
          cancelBtn.addEventListener('click',()=>{
            const ticket=cancelBtn.dataset.ticket;
            const id=cancelBtn.dataset.id;
            const modal=document.getElementById('confirmCancelModal');
            const input=document.getElementById('cancelTicketInput');
            const confirmBtn=document.getElementById('confirmTicketBtn');
            const cancelBtnModal=document.getElementById('cancelTicketBtn');

            modal.classList.remove('hidden'); input.value='';
            confirmBtn.onclick=async ()=>{
              if(input.value.trim()===ticket){
                await deleteBooking(id);
                modal.classList.add('hidden');
                const info=`Sala ${b.room} – ${b.start_time} às ${calculateEndTime(b.start_time,b.duration)} – ${b.date}`;
                document.getElementById('consultCancelInfo').textContent=info;
                document.getElementById('consultCancelSuccess').classList.remove('hidden');
              }else alert('Ticket incorreto!');
            };
            cancelBtnModal.onclick=()=>modal.classList.add('hidden');
          });
        });
      });

      // fechar consulta
      document.getElementById('closeConsult').addEventListener('click',()=>document.getElementById('consultScreen').classList.add('hidden'));

      // filtro da consulta
      document.getElementById('searchBookings').addEventListener('click', async ()=>{
        const filterDate=document.getElementById('consultDate').value;
        const filterSearch=(document.getElementById('consultSearch').value||'').toLowerCase();
        const filterRoom=document.getElementById('consultRoom').value;
        const filterTime=document.getElementById('consultTime').value;
        const filterSector=document.getElementById('consultSector').value;

        const bookings=await getAllBookings();
        const container=document.getElementById('bookingsResults');
        container.innerHTML='';

        bookings.filter(b=>{
          const matchDate=!filterDate||b.date===filterDate;
          const matchRoom=!filterRoom||b.room===filterRoom;
          const matchTime=!filterTime||b.start_time===filterTime;
          const matchSector=!filterSector||b.sector===filterSector;
          const matchSearch=!filterSearch||(b.name.toLowerCase().includes(filterSearch)||b.room.toLowerCase().includes(filterSearch)||b.start_time.toLowerCase().includes(filterSearch)||b.ticket.toLowerCase().includes(filterSearch));
          return matchDate&&matchRoom&&matchTime&&matchSector&&matchSearch;
        }).forEach(b=>{
          const div=document.createElement('div');
          div.className='border border-blue-500 rounded-lg shadow-md p-4 mb-4 bg-white relative';
          div.innerHTML=`
            <div class="absolute top-0 right-0 m-2 px-2 py-1 bg-gray-200 text-xs rounded">${b.sector}</div>
            <h2 class="text-lg font-semibold mb-1">Sala ${b.room}</h2>
            <p><i class="fa fa-user mr-1"></i> ${b.name}</p>
            <p><i class="fa fa-calendar mr-1"></i> ${b.date}</p>
            <p><i class="fa fa-clock mr-1"></i> ${b.start_time} - ${calculateEndTime(b.start_time,b.duration)}</p>
            <button class="cancel-btn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded mt-1" data-id="${b.id}" data-ticket="${b.ticket}">
              <i class="fas fa-times mr-1"></i> Cancelar
            </button>`;
          container.appendChild(div);

          const cancelBtn=div.querySelector('.cancel-btn');
          cancelBtn.addEventListener('click',()=>{
            const ticket=cancelBtn.dataset.ticket, id=cancelBtn.dataset.id;
            const modal=document.getElementById('confirmCancelModal');
            const input=document.getElementById('cancelTicketInput');
            const confirmBtn=document.getElementById('confirmTicketBtn');
            const cancelBtnModal=document.getElementById('cancelTicketBtn');

            modal.classList.remove('hidden'); input.value='';
            confirmBtn.onclick=async ()=>{
              if(input.value.trim()===ticket){
                await deleteBooking(id);
                modal.classList.add('hidden');
                const info=`Sala ${b.room} – ${b.start_time} às ${calculateEndTime(b.start_time,b.duration)} – ${b.date}`;
                document.getElementById('consultCancelInfo').textContent=info;
                document.getElementById('consultCancelSuccess').classList.remove('hidden');
              }else alert('Ticket incorreto!');
            };
            cancelBtnModal.onclick=()=>modal.classList.add('hidden');
          });
        });
      });

      // limpar filtros consulta
      document.getElementById('clearConsultFilters').addEventListener('click',()=>{
        document.getElementById('consultDate').value='';
        document.getElementById('consultSearch').value='';
        document.getElementById('consultRoom').value='';
        document.getElementById('consultTime').value='';
        document.getElementById('consultSector').value='';
        document.getElementById('searchBookings').click();
      });

      // botões finais
      document.getElementById('goToConsult').addEventListener('click',async ()=>{
        document.getElementById('confirmationModal').classList.add('hidden');
        document.getElementById('consultButton').click();
      });
      document.getElementById('cancelBackToConsult').addEventListener('click',()=>{
        document.getElementById('consultCancelSuccess').classList.add('hidden');
        document.getElementById('consultButton').click();
      });
    });
  </script>
</body>
</html>
